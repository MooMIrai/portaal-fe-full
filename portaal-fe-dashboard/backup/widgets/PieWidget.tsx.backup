import React from 'react';
import { Card, CardHeader, CardBody } from '@progress/kendo-react-layout';
import { Chart, ChartSeries, ChartSeriesItem, ChartLegend, ChartTooltip } from '@progress/kendo-react-charts';
import { WidgetProps } from '../../../types/widgetConfig.types';
import { PieConfig } from '../../../types/widgetConfig.types';

export const PieWidget: React.FC<WidgetProps<PieConfig>> = ({ data, config, computed }) => {
  // Process data for pie chart
  const chartData = data.map((item: any) => ({
    category: item[config.categoryField || 'category'],
    value: item[config.valueField || 'value'],
    color: item.color
  }));
  
  const labelContent = (e: any) => {
    if (!config.showLabels) return '';
    const percentage = (e.value / (computed?.total || 100)) * 100;
    return `${e.category}: ${percentage.toFixed(1)}%`;
  };
  
  return (
    <Card style={{ width: '100%', height: '100%' }}>
      <CardHeader className="bg-gray-50 px-4 py-3">
        <h3 className="text-lg font-semibold">{config.title}</h3>
        {config.description && (
          <p className="text-sm text-gray-600 mt-1">{config.description}</p>
        )}
      </CardHeader>
      <CardBody className="p-4">
        <Chart style={{ height: '100%' }}>
          <ChartSeries>
            <ChartSeriesItem
              type="pie"
              data={chartData}
              field="value"
              categoryField="category"
              colorField="color"
              labels={{
                visible: config.showLabels !== false,
                position: config.labelPosition || 'outside',
                content: labelContent,
                background: 'transparent',
                color: '#333',
                font: '12px Arial, sans-serif'
              }}
              tooltip={{
                visible: true,
                format: config.tooltipFormat || '{0}: {1}'
              }}
            />
          </ChartSeries>
          {config.showLegend !== false && (
            <ChartLegend 
              position={config.legendPosition || 'bottom'}
              padding={{ top: 20 }}
            />
          )}
          <ChartTooltip />
        </Chart>
      </CardBody>
    </Card>
  );
};