import React from 'react';
import { Card, CardHeader, CardBody } from '@progress/kendo-react-layout';
import { Chart, ChartSeries, ChartSeriesItem, ChartCategoryAxis, ChartCategoryAxisItem, ChartValueAxis, ChartValueAxisItem, ChartLegend, ChartTooltip } from '@progress/kendo-react-charts';
import { WidgetProps } from '../../../types/widgetConfig.types';
import { BarConfig } from '../../../types/widgetConfig.types';

export const BarWidget: React.FC<WidgetProps<BarConfig>> = ({ data, config }) => {
  // Handle multiple value fields (for grouped bars)
  const valueFields = Array.isArray(config.valueField) ? config.valueField : [config.valueField];
  const colors = Array.isArray(config.color) ? config.color : [config.color || '#3498db'];
  
  // Extract categories
  const categories = data.map((item: any) => item[config.categoryField || 'category']);
  
  return (
    <Card style={{ width: '100%', height: '100%' }}>
      <CardHeader className="bg-gray-50 px-4 py-3">
        <h3 className="text-lg font-semibold">{config.title}</h3>
        {config.description && (
          <p className="text-sm text-gray-600 mt-1">{config.description}</p>
        )}
      </CardHeader>
      <CardBody className="p-4">
        <Chart style={{ height: '100%' }}>
          <ChartCategoryAxis>
            <ChartCategoryAxisItem 
              categories={categories}
              labels={{
                rotation: config.orientation === 'horizontal' ? 0 : -45
              }}
            />
          </ChartCategoryAxis>
          <ChartValueAxis>
            <ChartValueAxisItem
              labels={{
                format: config.valueFormat || '{0}'
              }}
            />
          </ChartValueAxis>
          <ChartSeries>
            {valueFields.map((field, index) => (
              <ChartSeriesItem
                key={field}
                type={config.orientation === 'horizontal' ? 'bar' : 'column'}
                data={data.map((item: any) => item[field])}
                color={colors[index] || colors[0]}
                stack={config.stacked}
                gap={config.gap || 1}
                spacing={config.spacing || 0.5}
                labels={{
                  visible: config.showValueLabels,
                  format: config.valueFormat || '{0}',
                  position: 'outsideEnd'
                }}
                name={config.legend?.labels?.[index] || field}
              />
            ))}
          </ChartSeries>
          {config.legend?.visible !== false && valueFields.length > 1 && (
            <ChartLegend 
              position="bottom"
              orientation="horizontal"
            />
          )}
          <ChartTooltip />
        </Chart>
      </CardBody>
    </Card>
  );
};